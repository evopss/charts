name: Helm Release
on:
  push:
    paths:
      - 'opensource/**/**'
      - '!**md'
    branches:
      - main
jobs:
  helm-release:
    runs-on: ubuntu-latest
    name: Update charts index
    steps:
      - name: checkout helm resource
        uses: actions/checkout@v3
        with:
          path: helm-source
          fetch-depth: 1
      - name: checkout helm repo
        uses: actions/checkout@v3
        with:
          path: helm-repo
          ref: gh-pages
          fetch-depth: 1
      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
      - name: Install Helm
        uses: azure/setup-helm@v3
      - name: Helm Package
        run: |
          files_changed="$(git show --pretty="" --name-only)"
          charts_dirs_changed="$(echo "$files_changed" | xargs dirname | grep -o "opensource/[^/]*/[^/]*" | sort | uniq || true)"
          for chart_name in $charts_dirs_changed; do
            helm package helm-source/$opensource/ -u -d helm-repo/
          done
          ls helm-repo/

